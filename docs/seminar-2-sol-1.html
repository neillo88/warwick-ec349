<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="u2100282">
<meta name="dcterms.date" content="2025-02-09">

<title>Student Solution – EC349</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">EC349</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-seminar-1" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Seminar 1</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-seminar-1">    
        <li>
    <a class="dropdown-item" href="./seminar-1.html">
 <span class="dropdown-text">Material</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-1-grp-1.html">
 <span class="dropdown-text">Group 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-1-grp-2.html">
 <span class="dropdown-text">Group 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-1-grp-3.html">
 <span class="dropdown-text">Group 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-1-grp-4.html">
 <span class="dropdown-text">Group 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-1-grp-5.html">
 <span class="dropdown-text">Group 5</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-seminar-2" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Seminar 2</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-seminar-2">    
        <li>
    <a class="dropdown-item" href="./seminar-2.html">
 <span class="dropdown-text">Material</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./seminar-2-sol-1.html">
 <span class="dropdown-text">Solution 1</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#loading-packages-data" id="toc-loading-packages-data" class="nav-link active" data-scroll-target="#loading-packages-data">loading packages &amp; data</a></li>
  <li><a href="#clean-data-prepare-training-testing-files" id="toc-clean-data-prepare-training-testing-files" class="nav-link" data-scroll-target="#clean-data-prepare-training-testing-files">Clean data &amp; prepare training + testing files</a></li>
  <li><a href="#linear-probability-model" id="toc-linear-probability-model" class="nav-link" data-scroll-target="#linear-probability-model">Linear Probability Model</a></li>
  <li><a href="#logit" id="toc-logit" class="nav-link" data-scroll-target="#logit">Logit</a></li>
  <li><a href="#lpm-with-penalisation-ridge-lasso" id="toc-lpm-with-penalisation-ridge-lasso" class="nav-link" data-scroll-target="#lpm-with-penalisation-ridge-lasso">LPM with penalisation (Ridge, LASSO)</a></li>
  <li><a href="#logit-with-penalisation-ridge-lasso" id="toc-logit-with-penalisation-ridge-lasso" class="nav-link" data-scroll-target="#logit-with-penalisation-ridge-lasso">Logit with penalisation (Ridge, LASSO)</a></li>
  <li><a href="#regression-tree-with-tree" id="toc-regression-tree-with-tree" class="nav-link" data-scroll-target="#regression-tree-with-tree">Regression tree (with <code>tree</code>)</a>
  <ul class="collapse">
  <li><a href="#pruned-tree" id="toc-pruned-tree" class="nav-link" data-scroll-target="#pruned-tree">Pruned tree</a></li>
  </ul></li>
  <li><a href="#regression-tree-with-rpart" id="toc-regression-tree-with-rpart" class="nav-link" data-scroll-target="#regression-tree-with-rpart">Regression tree (with <code>rpart</code>)</a></li>
  <li><a href="#bagging" id="toc-bagging" class="nav-link" data-scroll-target="#bagging">Bagging</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random Forest</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Student Solution</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>u2100282 </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 9, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The following proposed solution uses the “Heart.csv” file to predict incidences of heart disease among patients (i.e.&nbsp;the “AHD” variable). As this is a discrete outcome, some methods will use classification models.</p>
<section id="loading-packages-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-packages-data">loading packages &amp; data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tree)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># read in csv</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>heart_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"seminar-material/Heart.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clean-data-prepare-training-testing-files" class="level2">
<h2 class="anchored" data-anchor-id="clean-data-prepare-training-testing-files">Clean data &amp; prepare training + testing files</h2>
<p>Convert categorical variables to factors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>heart_cleaned <span class="ot">=</span> heart_raw <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(ChestPain, Thal), factor)) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AHD =</span> <span class="fu">ifelse</span>(AHD <span class="sc">==</span> <span class="st">"No"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">0</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>...<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create training and test data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>training_list <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(heart_cleaned), <span class="dv">3</span><span class="sc">*</span><span class="fu">nrow</span>(heart_cleaned)<span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>training_set <span class="ot">=</span> heart_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> training_list)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># covariates in training set</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>training_set_x <span class="ot">=</span> training_set <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>AHD)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y var in training set</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>training_set_y <span class="ot">=</span> training_set <span class="sc">%&gt;%</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(AHD)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">=</span> heart_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">row_number</span>() <span class="sc">%in%</span> training_list)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># covariates in test set</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>test_set_x <span class="ot">=</span> test_set <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>AHD)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># y var in test set</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>test_set_y <span class="ot">=</span> test_set <span class="sc">%&gt;%</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(AHD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="linear-probability-model" class="level2">
<h2 class="anchored" data-anchor-id="linear-probability-model">Linear Probability Model</h2>
<p>Estimate LPM</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lm_heart <span class="ot">=</span> <span class="fu">lm</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = AHD ~ ., data = training_set)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.95305 -0.22780 -0.03695  0.18969  0.93653 

Coefficients:
                      Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)          0.2421555  0.3864105   0.627 0.531567    
Age                 -0.0027566  0.0033881  -0.814 0.416812    
Sex                  0.1790580  0.0584518   3.063 0.002483 ** 
ChestPainnonanginal -0.2186487  0.0646517  -3.382 0.000862 ***
ChestPainnontypical -0.1978742  0.0783460  -2.526 0.012305 *  
ChestPaintypical    -0.2671775  0.0967247  -2.762 0.006262 ** 
RestBP               0.0027032  0.0014410   1.876 0.062088 .  
Chol                 0.0004496  0.0004828   0.931 0.352899    
Fbs                 -0.0769553  0.0731226  -1.052 0.293848    
RestECG              0.0317033  0.0254639   1.245 0.214543    
MaxHR               -0.0026952  0.0014136  -1.907 0.057968 .  
ExAng                0.0912519  0.0627836   1.453 0.147632    
Oldpeak              0.0177934  0.0302302   0.589 0.556778    
Slope                0.0854202  0.0547350   1.561 0.120157    
Ca                   0.1528525  0.0300224   5.091 8.03e-07 ***
Thalnormal          -0.0864777  0.1100964  -0.785 0.433083    
Thalreversable       0.1085007  0.1029830   1.054 0.293316    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3535 on 205 degrees of freedom
Multiple R-squared:  0.5346,    Adjusted R-squared:  0.4982 
F-statistic: 14.72 on 16 and 205 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Compute and plot predicted values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lm_pred <span class="ot">=</span> <span class="fu">predict</span>(lm_heart, <span class="at">newdata =</span> test_set_x)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add to a predictions dataset</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> test_set_y <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(lm_pred)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting predictions against actual values of AHD</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plus regression line (with standard errors)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> lm_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store MSE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mse_lm <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>lm_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="logit" class="level2">
<h2 class="anchored" data-anchor-id="logit">Logit</h2>
<p>Estimate logit model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>logit_heart <span class="ot">=</span> <span class="fu">glm</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(logit_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = AHD ~ ., family = binomial(link = "logit"), data = training_set)

Coefficients:
                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)         -4.150966   3.435225  -1.208  0.22691    
Age                 -0.023463   0.029751  -0.789  0.43033    
Sex                  1.804318   0.603192   2.991  0.00278 ** 
ChestPainnonanginal -1.753466   0.569798  -3.077  0.00209 ** 
ChestPainnontypical -1.186858   0.659783  -1.799  0.07204 .  
ChestPaintypical    -2.058178   0.739613  -2.783  0.00539 ** 
RestBP               0.027662   0.012578   2.199  0.02786 *  
Chol                 0.006939   0.004460   1.556  0.11969    
Fbs                 -0.580343   0.692135  -0.838  0.40176    
RestECG              0.215295   0.217382   0.990  0.32198    
MaxHR               -0.023207   0.013539  -1.714  0.08651 .  
ExAng                0.622182   0.511284   1.217  0.22364    
Oldpeak              0.144425   0.283812   0.509  0.61084    
Slope                0.873239   0.458705   1.904  0.05695 .  
Ca                   1.346442   0.315736   4.264    2e-05 ***
Thalnormal          -0.093183   0.984062  -0.095  0.92456    
Thalreversable       0.942034   0.949106   0.993  0.32093    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 305.95  on 221  degrees of freedom
Residual deviance: 150.14  on 205  degrees of freedom
AIC: 184.14

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>Compute and plot the predicted values. Note, logit is a linear regression of log-odds on covariates. Without specifying type = “response”, it will give you the predicted log-odds. Use <code>type = "response"</code> to convert these log-odds into probabilities using logistic function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>logit_pred <span class="ot">=</span> <span class="fu">predict</span>(logit_heart, <span class="at">newdata =</span> test_set_x,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add to a predictions dataset</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(logit_pred)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting predictions against actual values of AHD</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plus regression line (with standard errors)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> logit_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"binomial"</span>),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store the MSE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mse_logit <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>logit_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lpm-with-penalisation-ridge-lasso" class="level2">
<h2 class="anchored" data-anchor-id="lpm-with-penalisation-ridge-lasso">LPM with penalisation (Ridge, LASSO)</h2>
<p>Create matrix of training data covariates and y values for these glmnet regressions. Noe, <code>-1</code> removes column of intercepts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>. <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> training_set_x)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>. <span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> training_set_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ridge regression (alpha is lasso penalty, lambda is ridge penalty, so alpha = 0). If lambda is not explicitly chosen, <code>glmnet</code> fits the model for a sequence (100) of lambda values and provides regressions for each lambda.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ridge (alpha=0)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ridge_lm <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO (alpha = 1)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>lasso_lm <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find optimal lambda using cross-validation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cv_ridge <span class="ot">=</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_ridge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cv_lasso <span class="ot">=</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Can use minimum or highest lambda value within 1 se of the minimum value; i.e.&nbsp;statistically indistiguishable but encourages the most parsimony.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>best_lambda_ridge <span class="ot">&lt;-</span> cv_ridge<span class="sc">$</span>lambda.min</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>best_lambda_lasso <span class="ot">&lt;-</span> cv_lasso<span class="sc">$</span>lambda.min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Re-estimate using cross-validated lambdas</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ridge_lm <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> best_lambda_ridge)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(ridge_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18 x 1 sparse Matrix of class "dgCMatrix"
                                 s0
(Intercept)            0.1949964465
Age                   -0.0001486077
Sex                    0.1318820062
ChestPainasymptomatic  0.1239429970
ChestPainnonanginal   -0.0757550405
ChestPainnontypical   -0.0561441225
ChestPaintypical      -0.0974488394
RestBP                 0.0016269983
Chol                   0.0002823434
Fbs                   -0.0479978216
RestECG                0.0275318571
MaxHR                 -0.0023282165
ExAng                  0.0943465699
Oldpeak                0.0318760159
Slope                  0.0596369624
Ca                     0.1075913668
Thalnormal            -0.1027598013
Thalreversable         0.0933925932</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>lasso_lm <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> best_lambda_lasso)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(lasso_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18 x 1 sparse Matrix of class "dgCMatrix"
                                 s0
(Intercept)            0.5394031490
Age                    .           
Sex                    .           
ChestPainasymptomatic  0.0311738079
ChestPainnonanginal    .           
ChestPainnontypical    .           
ChestPaintypical       .           
RestBP                 .           
Chol                   .           
Fbs                    .           
RestECG                .           
MaxHR                 -0.0004762322
ExAng                  .           
Oldpeak                .           
Slope                  .           
Ca                     0.0056972778
Thalnormal            -0.0555254843
Thalreversable         .           </code></pre>
</div>
</div>
<p>Make predictions on test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">=</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>. <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> test_set_x)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ridge_lm_pred <span class="ot">=</span> <span class="fu">predict</span>(ridge_lm, <span class="at">newx =</span> X_test, <span class="at">s =</span> best_lambda_ridge)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>lasso_lm_pred <span class="ot">=</span> <span class="fu">predict</span>(lasso_lm, <span class="at">newx =</span> X_test, <span class="at">s =</span> best_lambda_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Add ridge and lasso logit predictions to predictions dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ridge_lm_pred,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>            lasso_lm_pred) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ridge_lm_pred =</span> <span class="fu">last_col</span>(<span class="at">offset =</span> <span class="dv">1</span>),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">lasso_lm_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `s1` -&gt; `s1...4`
• `s1` -&gt; `s1...5`</code></pre>
</div>
</div>
<p>Plotting predictions against actual values of AHD with regression line (with standard errors) for Ridge,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> ridge_lm_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>and then LASSO.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> lasso_lm_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store MSEs</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mse_lm_ridge <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>ridge_lm_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mse_lm_lasso <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>lasso_lm_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="logit-with-penalisation-ridge-lasso" class="level2">
<h2 class="anchored" data-anchor-id="logit-with-penalisation-ridge-lasso">Logit with penalisation (Ridge, LASSO)</h2>
<p>Estimate models</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ridge regression (alpha = 0)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ridge_logit <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO (alpha = 1)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>lasso_logit <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find optimal lambda using cross-validation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>cv_ridge <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_ridge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>cv_lasso <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-21-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Best lambda values</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>best_lambda_ridge <span class="ot">&lt;-</span> cv_ridge<span class="sc">$</span>lambda.min</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>best_lambda_lasso <span class="ot">&lt;-</span> cv_lasso<span class="sc">$</span>lambda.min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Re-estimate using cross-validated lambdas</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ridge_logit <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> best_lambda_ridge)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(ridge_logit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18 x 1 sparse Matrix of class "dgCMatrix"
                                s0
(Intercept)           -2.661402839
Age                   -0.002610642
Sex                    0.957860963
ChestPainasymptomatic  0.769543615
ChestPainnonanginal   -0.526442599
ChestPainnontypical   -0.259377844
ChestPaintypical      -0.613834638
RestBP                 0.012988845
Chol                   0.002782430
Fbs                   -0.292254411
RestECG                0.182781847
MaxHR                 -0.014358323
ExAng                  0.540745355
Oldpeak                0.221090359
Slope                  0.407296108
Ca                     0.746793790
Thalnormal            -0.495527722
Thalreversable         0.564571575</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>lasso_logit <span class="ot">=</span> <span class="fu">glmnet</span>(X, y, <span class="at">family =</span> <span class="st">"binomial"</span>,<span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">lambda =</span> best_lambda_lasso)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(lasso_logit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18 x 1 sparse Matrix of class "dgCMatrix"
                                s0
(Intercept)           -3.162812284
Age                    .          
Sex                    1.042538876
ChestPainasymptomatic  1.353767797
ChestPainnonanginal    .          
ChestPainnontypical    .          
ChestPaintypical       .          
RestBP                 0.011537202
Chol                   0.002119158
Fbs                   -0.070976617
RestECG                0.114921995
MaxHR                 -0.014420841
ExAng                  0.481805396
Oldpeak                0.144953650
Slope                  0.429642894
Ca                     0.888321133
Thalnormal            -0.308037617
Thalreversable         0.684159842</code></pre>
</div>
</div>
<p>Outside of sample rediction plotted</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ridge_logit_pred <span class="ot">=</span> <span class="fu">predict</span>(ridge_logit, <span class="at">newx =</span> X_test, <span class="at">s =</span> best_lambda_ridge, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>lasso_logit_pred <span class="ot">=</span> <span class="fu">predict</span>(lasso_logit, <span class="at">newx =</span> X_test, <span class="at">s =</span> best_lambda_lasso, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add ridge and lasso logit predictions to predictions dataset</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ridge_logit_pred,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>            lasso_logit_pred) <span class="sc">%&gt;%</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ridge_logit_pred =</span> <span class="fu">last_col</span>(<span class="at">offset =</span> <span class="dv">1</span>),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">lasso_logit_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `s1` -&gt; `s1...6`
• `s1` -&gt; `s1...7`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting predictions against actual values of AHD</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plus regression line (with standard errors)</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> ridge_logit_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"binomial"</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And for LASSO</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> lasso_logit_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"binomial"</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store MSE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mse_logit_ridge <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>ridge_logit_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>mse_logit_lasso <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>lasso_logit_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="regression-tree-with-tree" class="level2">
<h2 class="anchored" data-anchor-id="regression-tree-with-tree">Regression tree (with <code>tree</code>)</h2>
<p>Begin by converting AHD to factor variable</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>training_set_AHD_fact <span class="ot">=</span> training_set <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AHD =</span> <span class="fu">as.factor</span>(AHD))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Estimate and plot tree using <code>tree</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>tree_heart <span class="ot">=</span> <span class="fu">tree</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set_AHD_fact)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tree_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
tree(formula = AHD ~ ., data = training_set_AHD_fact)
Variables actually used in tree construction:
[1] "Thal"      "Ca"        "RestBP"    "Chol"      "MaxHR"     "Oldpeak"  
[7] "Slope"     "Sex"       "ChestPain"
Number of terminal nodes:  17 
Residual mean deviance:  0.4809 = 98.57 / 205 
Misclassification error rate: 0.1126 = 25 / 222 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tree_heart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>node), split, n, deviance, yval, (yprob)
      * denotes terminal node

  1) root 222 306.000 0 ( 0.54505 0.45495 )  
    2) Thal: normal 125 137.800 0 ( 0.76000 0.24000 )  
      4) Ca &lt; 0.5 86  61.820 0 ( 0.88372 0.11628 )  
        8) RestBP &lt; 156.5 81  42.780 0 ( 0.92593 0.07407 )  
         16) Chol &lt; 228.5 32   0.000 0 ( 1.00000 0.00000 ) *
         17) Chol &gt; 228.5 49  36.430 0 ( 0.87755 0.12245 )  
           34) MaxHR &lt; 169.5 30  30.020 0 ( 0.80000 0.20000 )  
             68) Oldpeak &lt; 1.25 25  18.350 0 ( 0.88000 0.12000 )  
              136) Oldpeak &lt; 0.1 13  14.050 0 ( 0.76923 0.23077 ) *
              137) Oldpeak &gt; 0.1 12   0.000 0 ( 1.00000 0.00000 ) *
             69) Oldpeak &gt; 1.25 5   6.730 1 ( 0.40000 0.60000 ) *
           35) MaxHR &gt; 169.5 19   0.000 0 ( 1.00000 0.00000 ) *
        9) RestBP &gt; 156.5 5   5.004 1 ( 0.20000 0.80000 ) *
      5) Ca &gt; 0.5 39  54.040 1 ( 0.48718 0.51282 )  
       10) Slope &lt; 1.5 26  32.100 0 ( 0.69231 0.30769 )  
         20) Sex &lt; 0.5 13   0.000 0 ( 1.00000 0.00000 ) *
         21) Sex &gt; 0.5 13  17.320 1 ( 0.38462 0.61538 )  
           42) ChestPain: nonanginal,nontypical,typical 8  10.590 0 ( 0.62500 0.37500 ) *
           43) ChestPain: asymptomatic 5   0.000 1 ( 0.00000 1.00000 ) *
       11) Slope &gt; 1.5 13   7.051 1 ( 0.07692 0.92308 ) *
    3) Thal: fixed,reversable 97 112.800 1 ( 0.26804 0.73196 )  
      6) ChestPain: nonanginal,nontypical,typical 37  51.050 0 ( 0.54054 0.45946 )  
       12) Ca &lt; 0.5 23  26.400 0 ( 0.73913 0.26087 )  
         24) Slope &lt; 1.5 7   0.000 0 ( 1.00000 0.00000 ) *
         25) Slope &gt; 1.5 16  21.170 0 ( 0.62500 0.37500 ) *
       13) Ca &gt; 0.5 14  14.550 1 ( 0.21429 0.78571 )  
         26) Chol &lt; 232 7   9.561 1 ( 0.42857 0.57143 ) *
         27) Chol &gt; 232 7   0.000 1 ( 0.00000 1.00000 ) *
      7) ChestPain: asymptomatic 60  39.010 1 ( 0.10000 0.90000 )  
       14) Oldpeak &lt; 0.55 11  14.420 1 ( 0.36364 0.63636 ) *
       15) Oldpeak &gt; 0.55 49  16.710 1 ( 0.04082 0.95918 )  
         30) Thal: fixed 10  10.010 1 ( 0.20000 0.80000 ) *
         31) Thal: reversable 39   0.000 1 ( 0.00000 1.00000 ) *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot tree</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_heart)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(tree_heart, <span class="at">pretty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Generate predicted values using <code>type = "vector"</code> to predict the probability that AHD = 1. Alternatively, can use <code>type = "class"</code> to predict the actual class. This produces 2 columns: the first has the probability AHD = 0 and the second the probability AHD = 1 (which is what we’re interested in).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>tree_pred <span class="ot">=</span> <span class="fu">predict</span>(tree_heart, <span class="at">newdata =</span> test_set_x, <span class="at">type =</span> <span class="st">"vector"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># note we only keep the 2nd column of `tree_pred` as explained above</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(tree_pred[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tree_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...8`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot predicted values against actual values</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> tree_pred, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store MSE. Note, this is the same as the misclassification rate for a binary (0/1) variable. Trees are very sensitive to the sample (overfits - high variance). The tendency to overfit is because of sequential design of trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>mse_tree <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>AHD <span class="sc">-</span> predictions_dataset<span class="sc">$</span>tree_pred)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="pruned-tree" class="level3">
<h3 class="anchored" data-anchor-id="pruned-tree">Pruned tree</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>cvtree_heart <span class="ot">=</span> <span class="fu">cv.tree</span>(tree_heart, <span class="at">FUN =</span> prune.tree)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cvtree_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "size"   "dev"    "k"      "method"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>cvtree_heart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$size
 [1] 17 16 15 14 13 11 10  9  8  7  6  5  4  3  2  1

$dev
 [1] 407.5569 385.4016 366.2669 367.3015 343.6143 327.9664 328.5242 328.5242
 [9] 325.9152 267.8555 259.0320 260.1638 260.1638 277.7223 278.2690 309.3478

$k
 [1]      -Inf  4.300942  4.947779  4.987522  5.232343  6.376143  6.703877
 [8]  6.738228  7.877432 10.098779 14.044109 14.773333 14.892341 21.905580
[15] 22.713030 55.410752

$method
[1] "deviance"

attr(,"class")
[1] "prune"         "tree.sequence"</code></pre>
</div>
</div>
<p>Plot size of tree and cost-complexity parameter against deviance (number of misclassifications). We can visually see that a tree size of 6 (6 terminal nodes) gives minimal deviance. Increasing the tree size beyond that is resulting in overfitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvtree_heart<span class="sc">$</span>size, cvtree_heart<span class="sc">$</span>dev, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cvtree_heart<span class="sc">$</span>k, cvtree_heart<span class="sc">$</span>dev, <span class="at">type =</span> <span class="st">"b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#returning plots back to 1 plot per figure</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the minimal deviance obtains this value, 6</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>optimal_size <span class="ot">=</span> cvtree_heart<span class="sc">$</span>size[<span class="fu">which.min</span>(cvtree_heart<span class="sc">$</span>dev)]</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>optimal_size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>Prune tree and generate new predicted values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>prune_heart <span class="ot">=</span> <span class="fu">prune.tree</span>(tree_heart, <span class="at">best =</span> optimal_size)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prune_heart)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(prune_heart, <span class="at">pretty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate predicted values from pruned tree</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>prune_tree_pred <span class="ot">=</span> <span class="fu">predict</span>(prune_heart, <span class="at">newdata =</span> test_set_x, <span class="at">type =</span> <span class="st">"vector"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(prune_tree_pred[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">prune_tree_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...9`</code></pre>
</div>
</div>
<p>Compute and store MSE. Note. this is the same as the misclassification rate for a binary (0/1) variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>mse_prune_tree <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>AHD <span class="sc">-</span> predictions_dataset<span class="sc">$</span>prune_tree_pred)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="regression-tree-with-rpart" class="level2">
<h2 class="anchored" data-anchor-id="regression-tree-with-rpart">Regression tree (with <code>rpart</code>)</h2>
<p>AHD is a binary variable, so the <code>class</code> method is assumed</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>tree_heart_rpart <span class="ot">=</span> <span class="fu">rpart</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set_AHD_fact, <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tree_heart_rpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
rpart(formula = AHD ~ ., data = training_set_AHD_fact, method = "class")
  n= 222 

          CP nsplit rel error    xerror       xstd
1 0.44554455      0 1.0000000 1.0000000 0.07346078
2 0.05940594      1 0.5544554 0.7128713 0.06905800
3 0.05445545      3 0.4356436 0.6237624 0.06650755
4 0.01000000      5 0.3267327 0.5049505 0.06205621

Variable importance
     Thal     MaxHR        Ca ChestPain       Sex   Oldpeak     ExAng     Slope 
       22        12        11        10        10         9         8         7 
      Age    RestBP   RestECG      Chol 
        4         2         2         2 

Node number 1: 222 observations,    complexity param=0.4455446
  predicted class=0  expected loss=0.454955  P(node) =1
    class counts:   121   101
   probabilities: 0.545 0.455 
  left son=2 (125 obs) right son=3 (97 obs)
  Primary splits:
      Thal      splits as  RLR,       improve=26.43724, (0 missing)
      Ca        &lt; 0.5   to the left,  improve=26.35143, (0 missing)
      MaxHR     &lt; 150.5 to the right, improve=25.49278, (0 missing)
      ChestPain splits as  RLLL,      improve=24.75130, (0 missing)
      Oldpeak   &lt; 1.7   to the left,  improve=19.60541, (0 missing)
  Surrogate splits:
      MaxHR   &lt; 150.5 to the right, agree=0.707, adj=0.330, (0 split)
      Slope   &lt; 1.5   to the left,  agree=0.698, adj=0.309, (0 split)
      Oldpeak &lt; 1.55  to the left,  agree=0.694, adj=0.299, (0 split)
      ExAng   &lt; 0.5   to the left,  agree=0.685, adj=0.278, (0 split)
      Sex     &lt; 0.5   to the left,  agree=0.649, adj=0.196, (0 split)

Node number 2: 125 observations,    complexity param=0.05940594
  predicted class=0  expected loss=0.24  P(node) =0.5630631
    class counts:    95    30
   probabilities: 0.760 0.240 
  left son=4 (86 obs) right son=5 (39 obs)
  Primary splits:
      Ca        &lt; 0.5   to the left,  improve=8.438402, (0 missing)
      ChestPain splits as  RLLR,      improve=6.923375, (0 missing)
      MaxHR     &lt; 119.5 to the right, improve=5.609579, (0 missing)
      Oldpeak   &lt; 1.7   to the left,  improve=4.833038, (0 missing)
      ExAng     &lt; 0.5   to the left,  improve=4.474680, (0 missing)
  Surrogate splits:
      Age       &lt; 62.5  to the left,  agree=0.760, adj=0.231, (0 split)
      MaxHR     &lt; 130.5 to the right, agree=0.736, adj=0.154, (0 split)
      ChestPain splits as  LLLR,      agree=0.704, adj=0.051, (0 split)
      Oldpeak   &lt; 1.7   to the left,  agree=0.704, adj=0.051, (0 split)

Node number 3: 97 observations,    complexity param=0.05445545
  predicted class=1  expected loss=0.2680412  P(node) =0.4369369
    class counts:    26    71
   probabilities: 0.268 0.732 
  left son=6 (37 obs) right son=7 (60 obs)
  Primary splits:
      ChestPain splits as  RLLL,      improve=8.883477, (0 missing)
      Ca        &lt; 0.5   to the left,  improve=8.188351, (0 missing)
      MaxHR     &lt; 144.5 to the right, improve=6.623394, (0 missing)
      Oldpeak   &lt; 0.7   to the left,  improve=6.113597, (0 missing)
      Slope     &lt; 1.5   to the left,  improve=3.431719, (0 missing)
  Surrogate splits:
      MaxHR   &lt; 144.5 to the right, agree=0.732, adj=0.297, (0 split)
      ExAng   &lt; 0.5   to the left,  agree=0.732, adj=0.297, (0 split)
      Oldpeak &lt; 0.7   to the left,  agree=0.680, adj=0.162, (0 split)
      RestBP  &lt; 109   to the left,  agree=0.660, adj=0.108, (0 split)
      Age     &lt; 63.5  to the right, agree=0.649, adj=0.081, (0 split)

Node number 4: 86 observations
  predicted class=0  expected loss=0.1162791  P(node) =0.3873874
    class counts:    76    10
   probabilities: 0.884 0.116 

Node number 5: 39 observations,    complexity param=0.05940594
  predicted class=1  expected loss=0.4871795  P(node) =0.1756757
    class counts:    19    20
   probabilities: 0.487 0.513 
  left son=10 (17 obs) right son=11 (22 obs)
  Primary splits:
      Sex       &lt; 0.5   to the left,  improve=6.818730, (0 missing)
      Slope     &lt; 1.5   to the left,  improve=6.564103, (0 missing)
      ChestPain splits as  RLLL,      improve=5.818730, (0 missing)
      ExAng     &lt; 0.5   to the left,  improve=2.857309, (0 missing)
      RestBP    &lt; 139   to the right, improve=2.632007, (0 missing)
  Surrogate splits:
      ChestPain splits as  RLLR,      agree=0.718, adj=0.353, (0 split)
      RestECG   &lt; 1     to the left,  agree=0.718, adj=0.353, (0 split)
      Age       &lt; 56.5  to the right, agree=0.692, adj=0.294, (0 split)
      RestBP    &lt; 136   to the right, agree=0.667, adj=0.235, (0 split)
      Chol      &lt; 292   to the right, agree=0.667, adj=0.235, (0 split)

Node number 6: 37 observations,    complexity param=0.05445545
  predicted class=0  expected loss=0.4594595  P(node) =0.1666667
    class counts:    20    17
   probabilities: 0.541 0.459 
  left son=12 (23 obs) right son=13 (14 obs)
  Primary splits:
      Ca     &lt; 0.5   to the left,  improve=4.794527, (0 missing)
      MaxHR  &lt; 143.5 to the right, improve=4.386315, (0 missing)
      Slope  &lt; 1.5   to the left,  improve=2.413343, (0 missing)
      Chol   &lt; 205.5 to the left,  improve=1.730759, (0 missing)
      RestBP &lt; 122.5 to the left,  improve=1.359745, (0 missing)
  Surrogate splits:
      MaxHR     &lt; 146.5 to the right, agree=0.730, adj=0.286, (0 split)
      Oldpeak   &lt; 1.95  to the left,  agree=0.703, adj=0.214, (0 split)
      Age       &lt; 68.5  to the left,  agree=0.676, adj=0.143, (0 split)
      ChestPain splits as  -RLL,      agree=0.676, adj=0.143, (0 split)
      Chol      &lt; 190.5 to the right, agree=0.649, adj=0.071, (0 split)

Node number 7: 60 observations
  predicted class=1  expected loss=0.1  P(node) =0.2702703
    class counts:     6    54
   probabilities: 0.100 0.900 

Node number 10: 17 observations
  predicted class=0  expected loss=0.1764706  P(node) =0.07657658
    class counts:    14     3
   probabilities: 0.824 0.176 

Node number 11: 22 observations
  predicted class=1  expected loss=0.2272727  P(node) =0.0990991
    class counts:     5    17
   probabilities: 0.227 0.773 

Node number 12: 23 observations
  predicted class=0  expected loss=0.2608696  P(node) =0.1036036
    class counts:    17     6
   probabilities: 0.739 0.261 

Node number 13: 14 observations
  predicted class=1  expected loss=0.2142857  P(node) =0.06306306
    class counts:     3    11
   probabilities: 0.214 0.786 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tree_heart_rpart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 222 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

 1) root 222 101 0 (0.5450450 0.4549550)  
   2) Thal=normal 125  30 0 (0.7600000 0.2400000)  
     4) Ca&lt; 0.5 86  10 0 (0.8837209 0.1162791) *
     5) Ca&gt;=0.5 39  19 1 (0.4871795 0.5128205)  
      10) Sex&lt; 0.5 17   3 0 (0.8235294 0.1764706) *
      11) Sex&gt;=0.5 22   5 1 (0.2272727 0.7727273) *
   3) Thal=fixed,reversable 97  26 1 (0.2680412 0.7319588)  
     6) ChestPain=nonanginal,nontypical,typical 37  17 0 (0.5405405 0.4594595)  
      12) Ca&lt; 0.5 23   6 0 (0.7391304 0.2608696) *
      13) Ca&gt;=0.5 14   3 1 (0.2142857 0.7857143) *
     7) ChestPain=asymptomatic 60   6 1 (0.1000000 0.9000000) *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot tree</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(tree_heart_rpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Generate and plot predicted values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>tree_pred_rpart <span class="ot">=</span> <span class="fu">predict</span>(tree_heart_rpart, <span class="at">newdata =</span> test_set_x, <span class="at">type =</span> <span class="st">"class"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">as.numeric</span>(tree_pred_rpart)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tree_pred_rpart =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...10`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot predicted values against actual values</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predictions_dataset, <span class="fu">aes</span>(<span class="at">x =</span> tree_pred_rpart, <span class="at">y =</span> AHD)) <span class="sc">+</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute and store MSE. Note, this is the same as the misclassification rate for a binary (0/1) variable. Trees are very sensitive to the sample (overfits - high variance). They have a tendency to overfit is because of sequential design of trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>mse_tree_rpart <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>AHD <span class="sc">-</span> predictions_dataset<span class="sc">$</span>tree_pred_rpart)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot cost-complexity parameter of tree</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(tree_heart_rpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Use CV to pick optimal cp parameter</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>optimal_cp <span class="ot">=</span> tree_heart_rpart<span class="sc">$</span>cptable[<span class="fu">which.min</span>(tree_heart_rpart<span class="sc">$</span>cptable[,<span class="st">"xerror"</span>]), <span class="st">"CP"</span>]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>optimal_cp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01</code></pre>
</div>
</div>
<p>Prune the tree</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>prune_heart_rpart <span class="ot">=</span> <span class="fu">prune</span>(tree_heart_rpart, <span class="at">cp =</span> optimal_cp)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot pruned tree</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(prune_heart_rpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Generate predicted values from pruned tree. Note, these predictions are saved as factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>prune_tree_rpart_pred <span class="ot">=</span> <span class="fu">predict</span>(prune_heart_rpart, <span class="at">newdata =</span> test_set_x, <span class="at">type =</span> <span class="st">"class"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">as.numeric</span>(prune_tree_rpart_pred)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">prune_tree_rpart_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...11`</code></pre>
</div>
</div>
<p>Compute and store MSE. Note, this is the same as the misclassification rate for a binary (0/1) variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>mse_prune_tree_rpart <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>AHD <span class="sc">-</span> predictions_dataset<span class="sc">$</span>prune_tree_rpart_pred)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bagging" class="level2">
<h2 class="anchored" data-anchor-id="bagging">Bagging</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># number of regressors is total number of x variables</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>bag_heart <span class="ot">=</span> <span class="fu">randomForest</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set_AHD_fact, <span class="at">mtry =</span> <span class="fu">ncol</span>(training_set_AHD_fact)<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>bag_heart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = AHD ~ ., data = training_set_AHD_fact,      mtry = ncol(training_set_AHD_fact) - 1, importance = TRUE) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 13

        OOB estimate of  error rate: 20.72%
Confusion matrix:
   0  1 class.error
0 98 23   0.1900826
1 23 78   0.2277228</code></pre>
</div>
</div>
<p>Generate predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>bag_pred <span class="ot">=</span> <span class="fu">predict</span>(bag_heart, <span class="at">newdata =</span> test_set_x)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">as.numeric</span>(bag_pred)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">bag_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...12`</code></pre>
</div>
</div>
<p>Compute and store MSE. Note, this is the same as the misclassification rate for a binary (0/1) variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>mse_bag <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>bag_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random Forest</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># number of x variables selected for inclusion in each tree is lower than the number of x variables. I chose 5</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>forest_heart <span class="ot">=</span> <span class="fu">randomForest</span>(AHD <span class="sc">~</span>., <span class="at">data =</span> training_set_AHD_fact, <span class="at">mtry =</span> <span class="dv">5</span>,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>forest_heart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = AHD ~ ., data = training_set_AHD_fact,      mtry = 5, importance = TRUE) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 5

        OOB estimate of  error rate: 18.47%
Confusion matrix:
    0  1 class.error
0 106 15   0.1239669
1  26 75   0.2574257</code></pre>
</div>
</div>
<p>Generate predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>forest_pred <span class="ot">=</span> <span class="fu">predict</span>(forest_heart, <span class="at">newdata =</span> test_set_x)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to predictions dataset</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>predictions_dataset <span class="ot">=</span> predictions_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">as.numeric</span>(forest_pred)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">forest_pred =</span> <span class="fu">last_col</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...13`</code></pre>
</div>
</div>
<p>Compute and store MSE. Note, this is the same as the misclassification rate for a binary (0/1) variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>mse_forest <span class="ot">=</span> <span class="fu">mean</span>((predictions_dataset<span class="sc">$</span>forest_pred <span class="sc">-</span> predictions_dataset<span class="sc">$</span>AHD)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>View importance of each variable</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(forest_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   0          1 MeanDecreaseAccuracy MeanDecreaseGini
Age        7.4813332  1.5625272           6.72565563        8.4384225
Sex       14.8645298  7.7057242          15.96165461        4.8548739
ChestPain  9.3111531 11.5074587          14.94983417       12.3559486
RestBP     1.5848401  2.0435154           2.35415853        8.4844240
Chol       2.1655147 -2.8478400          -0.09698318        8.5918130
Fbs        1.5604704 -0.6417825           0.90755919        0.7394629
RestECG    0.2401243  0.8172705           0.71520690        1.7564494
MaxHR     11.0172530  5.9234611          12.57651338       16.8039954
ExAng      4.6298814  4.9564873           6.90975700        4.9899581
Oldpeak   10.1551432 10.9200106          15.31150069       10.0643034
Slope      8.7171783  8.7564891          12.41001509        6.3931459
Ca        21.8972697 19.0532580          26.53962079       15.5191479
Thal      12.4311268  8.8729300          14.76064804       10.5493398</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(forest_heart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="seminar-2-sol-1_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variables starting with "mse_"</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>mse_vars <span class="ot">=</span> <span class="fu">ls</span>(<span class="at">pattern =</span> <span class="st">"^mse_"</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe with variable names and values</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>mse_df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">sub</span>(<span class="st">"^mse_"</span>, <span class="st">""</span>, mse_vars),</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mse =</span> <span class="fu">sapply</span>(mse_vars, get),</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>mse_df <span class="ot">=</span> mse_df <span class="sc">%&gt;%</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mse)</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="fu">view</span>(mse_df)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>mse_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               method        mse
mse_logit_ridge           logit_ridge 0.09556880
mse_logit_lasso           logit_lasso 0.09775592
mse_logit                       logit 0.10001662
mse_lm_ridge                 lm_ridge 0.10308230
mse_lm                             lm 0.10644605
mse_prune_tree             prune_tree 0.17054945
mse_forest                     forest 0.17333333
mse_tree                         tree 0.18526094
mse_bag                           bag 0.20000000
mse_prune_tree_rpart prune_tree_rpart 0.20000000
mse_tree_rpart             tree_rpart 0.20000000
mse_lm_lasso                 lm_lasso 0.21966165</code></pre>
</div>
</div>
<p>To view predictions_dataset for probabilistic/factor predictions under each model, run</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">view</span>(predictions_dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>